name: Regrada AI Tests

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write

jobs:
  regrada:
    name: AI Regression Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Regrada
        uses: regrada/setup-regrada@v1
        # Or install directly:
        # run: |
        #   curl -fsSL https://regrada.dev/install.sh | sh
        #   echo "$HOME/.regrada/bin" >> $GITHUB_PATH

      - name: Run AI evaluations
        id: regrada
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          regrada run --ci --output github

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read results if available
            let summary = '';
            let status = 'success';

            try {
              const result = JSON.parse(fs.readFileSync('.regrada/results.json', 'utf8'));

              const passRate = ((result.passed / result.total_tests) * 100).toFixed(1);

              summary = `## ðŸ¤– Regrada AI Test Results\n\n`;
              summary += `| Metric | Value |\n|--------|-------|\n`;
              summary += `| Total Tests | ${result.total_tests} |\n`;
              summary += `| Passed | ${result.passed} |\n`;
              summary += `| Failed | ${result.failed} |\n`;
              summary += `| Pass Rate | ${passRate}% |\n`;

              if (result.regressions > 0) {
                status = 'failure';
                summary += `\n### âš ï¸ Regressions Detected\n\n`;
                summary += `${result.regressions} test(s) that were passing are now failing:\n\n`;
                if (result.comparison?.new_failures) {
                  result.comparison.new_failures.forEach(name => {
                    summary += `- \`${name}\`\n`;
                  });
                }
              }

              if (result.failed > 0 && result.regressions === 0) {
                summary += `\n### Failed Tests\n\n`;
                result.test_results.filter(t => t.status === 'failed').forEach(t => {
                  summary += `- \`${t.name}\`\n`;
                  t.checks.filter(c => !c.passed).forEach(c => {
                    summary += `  - ${c.check}: ${c.message}\n`;
                  });
                });
              }

              if (result.comparison?.new_passes?.length > 0) {
                summary += `\n### âœ… Improvements\n\n`;
                summary += `${result.comparison.new_passes.length} test(s) are now passing:\n\n`;
                result.comparison.new_passes.forEach(name => {
                  summary += `- \`${name}\`\n`;
                });
              }

            } catch (e) {
              summary = `## ðŸ¤– Regrada AI Test Results\n\n`;
              summary += `âš ï¸ Could not parse results. Check the workflow logs for details.\n`;
            }

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Regrada AI Test Results')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }
